/*
  These C codes generated by Cpi version 3.0
  Copyright (C) 2019-2023 Alireza Rashti.
*/


#include "star_header.h"

double star_NS_baryonic_gConf_mass(Physics_T *const phys,const double Euler_C)
{
  Grid_T *const grid = mygrid(phys,Ftype("NS"));
  double NS_baryonic_mass = 0;

  FOR_ALL_p(grid->np)
  {
    Patch_T *patch = grid->patch[p];

    ADD_AND_ALLOC_FIELD(baryonic_mass_integrand)
    DECLARE_FIELD(baryonic_mass_integrand)
    READ_v(gConf_D0D0)
    READ_v(gConf_D0D1)
    READ_v(gConf_D0D2)
    READ_v(gConf_D1D1)
    READ_v(gConf_D1D2)
    READ_v(gConf_D2D2)
    READ_v(igConf_U0U0)
    READ_v(igConf_U0U1)
    READ_v(igConf_U0U2)
    READ_v(igConf_U1U1)
    READ_v(igConf_U1U2)
    READ_v(igConf_U2U2)
    READ_v(W_U0)
    READ_v(W_U1)
    READ_v(W_U2)
    READ_v(dphi_D0)
    READ_v(dphi_D1)
    READ_v(dphi_D2)
    READ_v(alphaPsi)
    READ_v(beta_U0)
    READ_v(beta_U1)
    READ_v(beta_U2)
    READ_v(psi)
    EoS_T *eos = init_EoS(phys);
    Uint nn = patch->nn;
    Uint ijk;
    double rho0;
  for(ijk = 0; ijk < nn; ++ijk)
  {
  double alpha =
alphaPsi[ijk]/psi[ijk];

  double psim4 =
pow(psi[ijk], -4);

  double psi4 =
pow(psi[ijk], 4);

  double psi6 =
pow(psi[ijk], 6);

  double P2 =
2.0*W_U0[ijk]*dphi_D0[ijk] + 2.0*W_U1[ijk]*dphi_D1[ijk] + 2.0*W_U2[ijk]*
dphi_D2[ijk] + psi4*(pow(W_U0[ijk], 2)*gConf_D0D0[ijk] + 2.0*W_U0[ijk]*
W_U1[ijk]*gConf_D0D1[ijk] + 2.0*W_U0[ijk]*W_U2[ijk]*gConf_D0D2[ijk] +
pow(W_U1[ijk], 2)*gConf_D1D1[ijk] + 2.0*W_U1[ijk]*W_U2[ijk]*
gConf_D1D2[ijk] + pow(W_U2[ijk], 2)*gConf_D2D2[ijk]) + psim4*
(pow(dphi_D0[ijk], 2)*igConf_U0U0[ijk] + 2.0*dphi_D0[ijk]*dphi_D1[ijk]*
igConf_U0U1[ijk] + 2.0*dphi_D0[ijk]*dphi_D2[ijk]*igConf_U0U2[ijk] +
pow(dphi_D1[ijk], 2)*igConf_U1U1[ijk] + 2.0*dphi_D1[ijk]*dphi_D2[ijk]*
igConf_U1U2[ijk] + pow(dphi_D2[ijk], 2)*igConf_U2U2[ijk]);

  double uW =
W_U0[ijk]*dphi_D0[ijk] + W_U1[ijk]*dphi_D1[ijk] + W_U2[ijk]*
dphi_D2[ijk] + psi4*(pow(W_U0[ijk], 2)*gConf_D0D0[ijk] + 2.0*W_U0[ijk]*
W_U1[ijk]*gConf_D0D1[ijk] + 2.0*W_U0[ijk]*W_U2[ijk]*gConf_D0D2[ijk] +
pow(W_U1[ijk], 2)*gConf_D1D1[ijk] + 2.0*W_U1[ijk]*W_U2[ijk]*
gConf_D1D2[ijk] + pow(W_U2[ijk], 2)*gConf_D2D2[ijk]);

  double Bdphi =
beta_U0[ijk]*dphi_D0[ijk] + beta_U1[ijk]*dphi_D1[ijk] + beta_U2[ijk]*
dphi_D2[ijk];

  double b =
2*pow(alpha, 2)*uW + pow(Bdphi - Euler_C, 2);

  double L2 =
(1.0/2.0)*(b + sqrt(-4*pow(alpha, 4)*pow(uW, 2) + pow(b, 2)))/
pow(alpha, 2);

  double h2 =
L2 - P2;

  double h =
sqrt(h2);

  double u0 =
sqrt(L2)/(alpha*h);


  if(!isfinite(h) || LSSEQL(h,1))
  {
    rho0 = 0;
    u0   = 0;
  }
  else
  {
    eos->h = h;
    rho0   = eos->rest_mass_density(eos);
  }

  baryonic_mass_integrand->v[ijk] = rho0*u0*alpha*psi6;
  }
  free_EoS(eos);
  Integration_T *I = init_integration();
  I->type = "Integral{f(x)dV},Spectral";
  I->Spectral->f = baryonic_mass_integrand;
  I->g00 = gConf_D0D0;
  I->g01 = gConf_D0D1;
  I->g02 = gConf_D0D2;
  I->g11 = gConf_D1D1;
  I->g12 = gConf_D1D2;
  I->g22 = gConf_D2D2;
  plan_integration(I);
  NS_baryonic_mass += execute_integration(I);
  free_integration(I);
  REMOVE_FIELD(baryonic_mass_integrand)
  }
  return NS_baryonic_mass;
}
