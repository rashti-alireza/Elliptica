/*
  These C codes generated by Cpi version 2.0
  Copyright (C) 2019-2021 Alireza Rashti.
*/


#include "obs_header.h"

#define add_and_get_field(name) \
  if (_Ind(#name) < 0) \
  {ADD_AND_ALLOC_FIELD(name);} \
  WRITE_v(name);


double obs_ADM_mass_SV_conformal(Observe_T *const obs);
double obs_ADM_mass_SV_conformal(Observe_T *const obs)
{
  double adm_mass = 0;
  struct items_S **adm = obs->items;
  const Uint N = obs->Nitems;
  Uint p;

  for(p = 0; p < N; ++p)
  {
  Patch_T *patch = adm[p]->patch;


  /* declaring: */
  READ_v(psi)
  READ_v(dpsi_D0)
  READ_v(dpsi_D1)
  READ_v(dpsi_D2)
  READ_v(gConf_D0D2)
  READ_v(gConf_D0D0)
  READ_v(gConf_D0D1)
  READ_v(gConf_D1D2)
  READ_v(gConf_D1D1)
  READ_v(gConf_D2D2)
  READ_v(AConfIJ_U0U1)
  READ_v(AConfIJ_U0U0)
  READ_v(AConfIJ_U0U2)
  READ_v(AConfIJ_U2U2)
  READ_v(AConfIJ_U1U1)
  READ_v(AConfIJ_U1U2)
  READ_v(trK)
  READ_v(EConf)
  READ_v(trRicciConf)
  add_and_get_field(obs__Ms)
  add_and_get_field(obs__Mv)


    Uint nn = patch->nn;
    Uint ijk;

    if (adm[p]->surface_integration_flg)
    {
      const double *n_U0 = adm[p]->n_U0;
      const double *n_U1 = adm[p]->n_U1;
      const double *n_U2 = adm[p]->n_U2;
      for (ijk = 0; ijk < nn; ++ijk)
      {
      double Ms = 
dpsi_D0[ijk]*n_U0[ijk] + dpsi_D1[ijk]*n_U1[ijk] + dpsi_D2[ijk]*
n_U2[ijk];

obs__Ms[ijk] = -Ms/(2.*M_PI);
      }
    }
    else
    {
      for (ijk = 0; ijk < nn; ++ijk)
      {
      double psi5 = 
pow(psi[ijk], 5);

      double psim6 = 
pow(psi[ijk], -6);

      double psim7 = 
psim6/psi[ijk];

      double E = 
EConf[ijk]*psim6;

      double A2 = 
pow(AConfIJ_U0U0[ijk], 2)*pow(gConf_D0D0[ijk], 2) + 4.0*
AConfIJ_U0U0[ijk]*AConfIJ_U0U1[ijk]*gConf_D0D0[ijk]*gConf_D0D1[ijk] +
4.0*AConfIJ_U0U0[ijk]*AConfIJ_U0U2[ijk]*gConf_D0D0[ijk]*
gConf_D0D2[ijk] + 2.0*AConfIJ_U0U0[ijk]*AConfIJ_U1U1[ijk]*
pow(gConf_D0D1[ijk], 2) + 4.0*AConfIJ_U0U0[ijk]*AConfIJ_U1U2[ijk]*
gConf_D0D1[ijk]*gConf_D0D2[ijk] + 2.0*AConfIJ_U0U0[ijk]*
AConfIJ_U2U2[ijk]*pow(gConf_D0D2[ijk], 2) + 2.0*pow(AConfIJ_U0U1[ijk], 2)*
gConf_D0D0[ijk]*gConf_D1D1[ijk] + 2.0*pow(AConfIJ_U0U1[ijk], 2)*
pow(gConf_D0D1[ijk], 2) + 4.0*AConfIJ_U0U1[ijk]*AConfIJ_U0U2[ijk]*
gConf_D0D0[ijk]*gConf_D1D2[ijk] + 4.0*AConfIJ_U0U1[ijk]*
AConfIJ_U0U2[ijk]*gConf_D0D1[ijk]*gConf_D0D2[ijk] + 4.0*
AConfIJ_U0U1[ijk]*AConfIJ_U1U1[ijk]*gConf_D0D1[ijk]*gConf_D1D1[ijk] +
4.0*AConfIJ_U0U1[ijk]*AConfIJ_U1U2[ijk]*gConf_D0D1[ijk]*
gConf_D1D2[ijk] + 4.0*AConfIJ_U0U1[ijk]*AConfIJ_U1U2[ijk]*
gConf_D0D2[ijk]*gConf_D1D1[ijk] + 4.0*AConfIJ_U0U1[ijk]*
AConfIJ_U2U2[ijk]*gConf_D0D2[ijk]*gConf_D1D2[ijk] + 2.0*
pow(AConfIJ_U0U2[ijk], 2)*gConf_D0D0[ijk]*gConf_D2D2[ijk] + 2.0*
pow(AConfIJ_U0U2[ijk], 2)*pow(gConf_D0D2[ijk], 2) + 4.0*
AConfIJ_U0U2[ijk]*AConfIJ_U1U1[ijk]*gConf_D0D1[ijk]*gConf_D1D2[ijk] +
4.0*AConfIJ_U0U2[ijk]*AConfIJ_U1U2[ijk]*gConf_D0D1[ijk]*
gConf_D2D2[ijk] + 4.0*AConfIJ_U0U2[ijk]*AConfIJ_U1U2[ijk]*
gConf_D0D2[ijk]*gConf_D1D2[ijk] + 4.0*AConfIJ_U0U2[ijk]*
AConfIJ_U2U2[ijk]*gConf_D0D2[ijk]*gConf_D2D2[ijk] + pow(AConfIJ_U1U1[ijk], 2)*
pow(gConf_D1D1[ijk], 2) + 4.0*AConfIJ_U1U1[ijk]*AConfIJ_U1U2[ijk]*
gConf_D1D1[ijk]*gConf_D1D2[ijk] + 2.0*AConfIJ_U1U1[ijk]*
AConfIJ_U2U2[ijk]*pow(gConf_D1D2[ijk], 2) + 2.0*pow(AConfIJ_U1U2[ijk], 2)*
gConf_D1D1[ijk]*gConf_D2D2[ijk] + 2.0*pow(AConfIJ_U1U2[ijk], 2)*
pow(gConf_D1D2[ijk], 2) + 4.0*AConfIJ_U1U2[ijk]*AConfIJ_U2U2[ijk]*
gConf_D1D2[ijk]*gConf_D2D2[ijk] + pow(AConfIJ_U2U2[ijk], 2)*
pow(gConf_D2D2[ijk], 2);

      double Mv = 
E*psi5 - 1.0/16.0*(-A2*psim7 + psi[ijk]*trRicciConf[ijk] + (2.0/3.0)*
psi5*pow(trK[ijk], 2))/M_PI;

obs__Mv[ijk] = Mv;
      }
    }

  }

  adm_mass = obs_integral_SV(obs,"obs__Ms","obs__Mv",'+','+');

  for(p = 0; p < N; ++p)
  {
    Patch_T *patch = adm[p]->patch;
    remove_field_regex(patch,"^obs__Ms$");
    remove_field_regex(patch,"^obs__Mv$");
  }

  return adm_mass;
}
