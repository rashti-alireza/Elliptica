/*
  These C codes generated by Cpi version 2.0
  Copyright (C) 2019-2021 Alireza Rashti.
*/


#include "obs_header.h"


#define add_and_get_field(name) \
  if (_Ind(#name) < 0) \
  {ADD_AND_ALLOC_FIELD(name);} \
  WRITE_v(name);

#define declare_and_alloc_xi(name) \
  double *name = alloc_double(nn);


void obs_ADM_J_S_default(Observe_T *const obs);
void obs_ADM_J_S_default(Observe_T *const obs)
{
  Physics_T *const phys = obs->phys;
  struct items_S **adm = obs->items;
  const Uint N = obs->Nitems;
  const double x_cm = sysGetd("x_CM");
  const double y_cm = sysGetd("y_CM");
  const double z_cm = sysGetd("z_CM");
  Uint p;

  for(p = 0; p < N; ++p)
  {
  Patch_T *patch = adm[p]->patch;
  Uint nn = patch->nn;
  Uint ijk;

  /* declaring: */
  READ_v(AConfIJ_U0U1)
  READ_v(AConfIJ_U0U0)
  READ_v(AConfIJ_U0U2)
  READ_v(AConfIJ_U2U2)
  READ_v(AConfIJ_U1U1)
  READ_v(AConfIJ_U1U2)
  READ_v(gConf_D0D2)
  READ_v(gConf_D0D0)
  READ_v(gConf_D0D1)
  READ_v(gConf_D1D2)
  READ_v(gConf_D1D1)
  READ_v(gConf_D2D2)
  READ_v(psi)
  READ_v(trK)
  add_and_get_field(obs__Jn_D1)
  add_and_get_field(obs__Jn_D0)
  add_and_get_field(obs__Jn_D2)
  declare_and_alloc_xi(xi_U2)
  declare_and_alloc_xi(xi_U0)
  declare_and_alloc_xi(xi_U1)



   for(ijk = 0; ijk < nn; ++ijk)
   {
   double x    = patch->node[ijk]->x[0];
   double y    = patch->node[ijk]->x[1];
   double z    = patch->node[ijk]->x[2];
   xi_U0[ijk] = x-x_cm;
   xi_U1[ijk] = y-y_cm;
   xi_U2[ijk] = z-z_cm;
   }
      const double *n_U0 = adm[p]->n_U0;
      const double *n_U1 = adm[p]->n_U1;
      const double *n_U2 = adm[p]->n_U2;

      for (ijk = 0; ijk < nn; ++ijk)
      {
      double psi4 = 
pow(psi[ijk], 4);

      double psim2 = 
pow(psi[ijk], -2);

      double Pn_D0 = 
-n_U0[ijk]*(0.66666666666666663*gConf_D0D0[ijk]*psi4*trK[ijk] - psim2*
(AConfIJ_U0U0[ijk]*pow(gConf_D0D0[ijk], 2) + 2.0*AConfIJ_U0U1[ijk]*
gConf_D0D0[ijk]*gConf_D0D1[ijk] + 2.0*AConfIJ_U0U2[ijk]*gConf_D0D0[ijk]*
gConf_D0D2[ijk] + AConfIJ_U1U1[ijk]*pow(gConf_D0D1[ijk], 2) + 2.0*
AConfIJ_U1U2[ijk]*gConf_D0D1[ijk]*gConf_D0D2[ijk] + AConfIJ_U2U2[ijk]*
pow(gConf_D0D2[ijk], 2))) - n_U1[ijk]*(0.66666666666666663*
gConf_D0D1[ijk]*psi4*trK[ijk] - psim2*(AConfIJ_U0U0[ijk]*
gConf_D0D0[ijk]*gConf_D0D1[ijk] + AConfIJ_U0U1[ijk]*gConf_D0D0[ijk]*
gConf_D1D1[ijk] + AConfIJ_U0U1[ijk]*pow(gConf_D0D1[ijk], 2) + 
AConfIJ_U0U2[ijk]*gConf_D0D0[ijk]*gConf_D1D2[ijk] + AConfIJ_U0U2[ijk]*
gConf_D0D1[ijk]*gConf_D0D2[ijk] + AConfIJ_U1U1[ijk]*gConf_D0D1[ijk]*
gConf_D1D1[ijk] + AConfIJ_U1U2[ijk]*gConf_D0D1[ijk]*gConf_D1D2[ijk] + 
AConfIJ_U1U2[ijk]*gConf_D0D2[ijk]*gConf_D1D1[ijk] + AConfIJ_U2U2[ijk]*
gConf_D0D2[ijk]*gConf_D1D2[ijk])) - n_U2[ijk]*(0.66666666666666663*
gConf_D0D2[ijk]*psi4*trK[ijk] - psim2*(AConfIJ_U0U0[ijk]*
gConf_D0D0[ijk]*gConf_D0D2[ijk] + AConfIJ_U0U1[ijk]*gConf_D0D0[ijk]*
gConf_D1D2[ijk] + AConfIJ_U0U1[ijk]*gConf_D0D1[ijk]*gConf_D0D2[ijk] + 
AConfIJ_U0U2[ijk]*gConf_D0D0[ijk]*gConf_D2D2[ijk] + AConfIJ_U0U2[ijk]*
pow(gConf_D0D2[ijk], 2) + AConfIJ_U1U1[ijk]*gConf_D0D1[ijk]*
gConf_D1D2[ijk] + AConfIJ_U1U2[ijk]*gConf_D0D1[ijk]*gConf_D2D2[ijk] + 
AConfIJ_U1U2[ijk]*gConf_D0D2[ijk]*gConf_D1D2[ijk] + AConfIJ_U2U2[ijk]*
gConf_D0D2[ijk]*gConf_D2D2[ijk]));

      double Pn_D1 = 
-n_U0[ijk]*(0.66666666666666663*gConf_D0D1[ijk]*psi4*trK[ijk] - psim2*
(AConfIJ_U0U0[ijk]*gConf_D0D0[ijk]*gConf_D0D1[ijk] + AConfIJ_U0U1[ijk]*
gConf_D0D0[ijk]*gConf_D1D1[ijk] + AConfIJ_U0U1[ijk]*
pow(gConf_D0D1[ijk], 2) + AConfIJ_U0U2[ijk]*gConf_D0D0[ijk]*
gConf_D1D2[ijk] + AConfIJ_U0U2[ijk]*gConf_D0D1[ijk]*gConf_D0D2[ijk] + 
AConfIJ_U1U1[ijk]*gConf_D0D1[ijk]*gConf_D1D1[ijk] + AConfIJ_U1U2[ijk]*
gConf_D0D1[ijk]*gConf_D1D2[ijk] + AConfIJ_U1U2[ijk]*gConf_D0D2[ijk]*
gConf_D1D1[ijk] + AConfIJ_U2U2[ijk]*gConf_D0D2[ijk]*gConf_D1D2[ijk])) - 
n_U1[ijk]*(0.66666666666666663*gConf_D1D1[ijk]*psi4*trK[ijk] - psim2*
(AConfIJ_U0U0[ijk]*pow(gConf_D0D1[ijk], 2) + 2.0*AConfIJ_U0U1[ijk]*
gConf_D0D1[ijk]*gConf_D1D1[ijk] + 2.0*AConfIJ_U0U2[ijk]*gConf_D0D1[ijk]*
gConf_D1D2[ijk] + AConfIJ_U1U1[ijk]*pow(gConf_D1D1[ijk], 2) + 2.0*
AConfIJ_U1U2[ijk]*gConf_D1D1[ijk]*gConf_D1D2[ijk] + AConfIJ_U2U2[ijk]*
pow(gConf_D1D2[ijk], 2))) - n_U2[ijk]*(0.66666666666666663*
gConf_D1D2[ijk]*psi4*trK[ijk] - psim2*(AConfIJ_U0U0[ijk]*
gConf_D0D1[ijk]*gConf_D0D2[ijk] + AConfIJ_U0U1[ijk]*gConf_D0D1[ijk]*
gConf_D1D2[ijk] + AConfIJ_U0U1[ijk]*gConf_D0D2[ijk]*gConf_D1D1[ijk] + 
AConfIJ_U0U2[ijk]*gConf_D0D1[ijk]*gConf_D2D2[ijk] + AConfIJ_U0U2[ijk]*
gConf_D0D2[ijk]*gConf_D1D2[ijk] + AConfIJ_U1U1[ijk]*gConf_D1D1[ijk]*
gConf_D1D2[ijk] + AConfIJ_U1U2[ijk]*gConf_D1D1[ijk]*gConf_D2D2[ijk] + 
AConfIJ_U1U2[ijk]*pow(gConf_D1D2[ijk], 2) + AConfIJ_U2U2[ijk]*
gConf_D1D2[ijk]*gConf_D2D2[ijk]));

      double Pn_D2 = 
-n_U0[ijk]*(0.66666666666666663*gConf_D0D2[ijk]*psi4*trK[ijk] - psim2*
(AConfIJ_U0U0[ijk]*gConf_D0D0[ijk]*gConf_D0D2[ijk] + AConfIJ_U0U1[ijk]*
gConf_D0D0[ijk]*gConf_D1D2[ijk] + AConfIJ_U0U1[ijk]*gConf_D0D1[ijk]*
gConf_D0D2[ijk] + AConfIJ_U0U2[ijk]*gConf_D0D0[ijk]*gConf_D2D2[ijk] + 
AConfIJ_U0U2[ijk]*pow(gConf_D0D2[ijk], 2) + AConfIJ_U1U1[ijk]*
gConf_D0D1[ijk]*gConf_D1D2[ijk] + AConfIJ_U1U2[ijk]*gConf_D0D1[ijk]*
gConf_D2D2[ijk] + AConfIJ_U1U2[ijk]*gConf_D0D2[ijk]*gConf_D1D2[ijk] + 
AConfIJ_U2U2[ijk]*gConf_D0D2[ijk]*gConf_D2D2[ijk])) - n_U1[ijk]*
(0.66666666666666663*gConf_D1D2[ijk]*psi4*trK[ijk] - psim2*
(AConfIJ_U0U0[ijk]*gConf_D0D1[ijk]*gConf_D0D2[ijk] + AConfIJ_U0U1[ijk]*
gConf_D0D1[ijk]*gConf_D1D2[ijk] + AConfIJ_U0U1[ijk]*gConf_D0D2[ijk]*
gConf_D1D1[ijk] + AConfIJ_U0U2[ijk]*gConf_D0D1[ijk]*gConf_D2D2[ijk] + 
AConfIJ_U0U2[ijk]*gConf_D0D2[ijk]*gConf_D1D2[ijk] + AConfIJ_U1U1[ijk]*
gConf_D1D1[ijk]*gConf_D1D2[ijk] + AConfIJ_U1U2[ijk]*gConf_D1D1[ijk]*
gConf_D2D2[ijk] + AConfIJ_U1U2[ijk]*pow(gConf_D1D2[ijk], 2) + 
AConfIJ_U2U2[ijk]*gConf_D1D2[ijk]*gConf_D2D2[ijk])) - n_U2[ijk]*
(0.66666666666666663*gConf_D2D2[ijk]*psi4*trK[ijk] - psim2*
(AConfIJ_U0U0[ijk]*pow(gConf_D0D2[ijk], 2) + 2.0*AConfIJ_U0U1[ijk]*
gConf_D0D2[ijk]*gConf_D1D2[ijk] + 2.0*AConfIJ_U0U2[ijk]*gConf_D0D2[ijk]*
gConf_D2D2[ijk] + AConfIJ_U1U1[ijk]*pow(gConf_D1D2[ijk], 2) + 2.0*
AConfIJ_U1U2[ijk]*gConf_D1D2[ijk]*gConf_D2D2[ijk] + AConfIJ_U2U2[ijk]*
pow(gConf_D2D2[ijk], 2)));

      double Jn_D2 = 
-Pn_D0*xi_U1[ijk] + Pn_D1*xi_U0[ijk];

      double Jn_D0 = 
-Pn_D1*xi_U2[ijk] + Pn_D2*xi_U1[ijk];

      double Jn_D1 = 
Pn_D0*xi_U2[ijk] - Pn_D2*xi_U0[ijk];


      /* populating: */
      obs__Jn_D1[ijk] = Jn_D1;
      obs__Jn_D0[ijk] = Jn_D0;
      obs__Jn_D2[ijk] = Jn_D2;
      }

  free(xi_U0);
  free(xi_U1);
  free(xi_U2);
  }

  obs->ret[0] = obs_integral_SV
                 (obs,"obs__Jn_D0",0,'+','+')/(8*M_PI);
  obs->ret[1] = obs_integral_SV
                 (obs,"obs__Jn_D1",0,'+','+')/(8*M_PI);
  obs->ret[2] = obs_integral_SV
                 (obs,"obs__Jn_D2",0,'+','+')/(8*M_PI);

  for(p = 0; p < N; ++p)
  {
    Patch_T *patch = adm[p]->patch;
    remove_field_regex(patch,"^obs__Jn_D.$");
  }

}
