/*
  These C codes generated by Cpi version 1.0
  Copyright (C) 2019 Alireza Rashti.
*/


#include "bbn_headers.h"
#include "maths_equation_solvings_lib.h"
#include "bbn_XCTS_equations_lib.h"


void *bbn_eq_phi(void *vp1,void *vp2)
{
  DDM_SCHUR_EQ_DECLARE
  unsigned ijk;/* node index */

  if (!strcmp_i(GetParameterS_E("grid_kind"),"BBN_CubedSpherical_grid"))
    abortEr("For this grid you need to figure out where to set phi = 0.\n");
  

  /* declaring: */
  READ_v_IF_IN_NS(dphi_D2)
  READ_v_IF_IN_NS(dphi_D1)
  READ_v_IF_IN_NS(dphi_D0)
  READ_v_IF_IN_NS(ddphi_D2D2)
  READ_v_IF_IN_NS(ddphi_D1D2)
  READ_v_IF_IN_NS(ddphi_D1D1)
  READ_v_IF_IN_NS(ddphi_D0D2)
  READ_v_IF_IN_NS(ddphi_D0D0)
  READ_v_IF_IN_NS(ddphi_D0D1)
  READ_v_IF_IN_NS(W_U1)
  READ_v_IF_IN_NS(W_U0)
  READ_v_IF_IN_NS(W_U2)
  READ_v_IF_IN_NS(enthalpy)
  READ_v_IF_IN_NS(denthalpy_D2)
  READ_v_IF_IN_NS(denthalpy_D0)
  READ_v_IF_IN_NS(denthalpy_D1)
  READ_v_IF_IN_NS(rho0)
  READ_v_IF_IN_NS(drho0_D2)
  READ_v_IF_IN_NS(drho0_D0)
  READ_v_IF_IN_NS(drho0_D1)
  READ_v_IF_IN_NS(u0)
  READ_v_IF_IN_NS(du0_D0)
  READ_v_IF_IN_NS(du0_D1)
  READ_v_IF_IN_NS(du0_D2)
  READ_v(eta)
  READ_v(deta_D0)
  READ_v(deta_D1)
  READ_v(deta_D2)
  READ_v(psi)
  READ_v(dpsi_D0)
  READ_v(dpsi_D1)
  READ_v(dpsi_D2)
  READ_v(K)
  READ_v(Beta_U1)
  READ_v(Beta_U0)
  READ_v(Beta_U2)
  READ_v(_gammaI_U0U2)
  READ_v(_gammaI_U0U0)
  READ_v(_gammaI_U0U1)
  READ_v(_gammaI_U1U2)
  READ_v(_gammaI_U1U1)
  READ_v(_gammaI_U2U2)
  READ_v(_Gamma_U2D1D1)
  READ_v(_Gamma_U2D1D2)
  READ_v(_Gamma_U0D1D1)
  READ_v(_Gamma_U2D0D2)
  READ_v(_Gamma_U2D2D2)
  READ_v(_Gamma_U0D1D2)
  READ_v(_Gamma_U0D0D2)
  READ_v(_Gamma_U0D0D1)
  READ_v(_Gamma_U0D0D0)
  READ_v(_Gamma_U1D2D2)
  READ_v(_Gamma_U2D0D1)
  READ_v(_Gamma_U0D2D2)
  READ_v(_Gamma_U2D0D0)
  READ_v(_Gamma_U1D0D2)
  READ_v(_Gamma_U1D1D2)
  READ_v(_Gamma_U1D0D0)
  READ_v(_Gamma_U1D0D1)
  READ_v(_Gamma_U1D1D1)


  const double rhoc = GetParameterD_E("rho_center");
  const double e    = GetParameterD_E("Solving_phi_Jacobian_smoothness");
  const double att  = e*rhoc;
  DDM_SCHUR_EQ_OPEN

  double dLn_of_alpha_U2 = 
deta_D2[ijk]/eta[ijk] - dpsi_D2[ijk]/psi[ijk];

  double dLn_of_alpha_U0 = 
deta_D0[ijk]/eta[ijk] - dpsi_D0[ijk]/psi[ijk];

  double dLn_of_alpha_U1 = 
deta_D1[ijk]/eta[ijk] - dpsi_D1[ijk]/psi[ijk];

  double dLn_of_enthalpy_U0 = 
denthalpy_D0[ijk]/enthalpy[ijk];

  double dLn_of_enthalpy_U1 = 
denthalpy_D1[ijk]/enthalpy[ijk];

  double dLn_of_enthalpy_U2 = 
denthalpy_D2[ijk]/enthalpy[ijk];

  double dLn_of_u0_U2 = 
du0_D2[ijk]/u0[ijk];

  double dLn_of_u0_U0 = 
du0_D0[ijk]/u0[ijk];

  double dLn_of_u0_U1 = 
du0_D1[ijk]/u0[ijk];

  double dLns0_U1 = 
drho0_D1[ijk] + rho0[ijk]*(dLn_of_alpha_U1 - dLn_of_enthalpy_U1);

  double dLns0_U0 = 
drho0_D0[ijk] + rho0[ijk]*(dLn_of_alpha_U0 - dLn_of_enthalpy_U0);

  double dLns0_U2 = 
drho0_D2[ijk] + rho0[ijk]*(dLn_of_alpha_U2 - dLn_of_enthalpy_U2);

  double dLns1_U2 = 
drho0_D2[ijk] + rho0[ijk]*(dLn_of_alpha_U2 + dLn_of_u0_U2);

  double dLns1_U0 = 
drho0_D0[ijk] + rho0[ijk]*(dLn_of_alpha_U0 + dLn_of_u0_U0);

  double dLns1_U1 = 
drho0_D1[ijk] + rho0[ijk]*(dLn_of_alpha_U1 + dLn_of_u0_U1);

  double alpha = 
eta[ijk]/psi[ijk];

  double t1 = 
dLns0_U0*(W_U0[ijk] + (_gammaI_U0U0[ijk]*dphi_D0[ijk] +
_gammaI_U0U1[ijk]*dphi_D1[ijk] + _gammaI_U0U2[ijk]*dphi_D2[ijk])/
pow(psi[ijk], 4)) + dLns0_U1*(W_U1[ijk] + (_gammaI_U0U1[ijk]*
dphi_D0[ijk] + _gammaI_U1U1[ijk]*dphi_D1[ijk] + _gammaI_U1U2[ijk]*
dphi_D2[ijk])/pow(psi[ijk], 4)) + dLns0_U2*(W_U2[ijk] +
(_gammaI_U0U2[ijk]*dphi_D0[ijk] + _gammaI_U1U2[ijk]*dphi_D1[ijk] +
_gammaI_U2U2[ijk]*dphi_D2[ijk])/pow(psi[ijk], 4));

  double t2 = 
2.0*(_gammaI_U0U0[ijk]*dphi_D0[ijk]*dpsi_D0[ijk] + _gammaI_U0U1[ijk]*
dphi_D0[ijk]*dpsi_D1[ijk] + _gammaI_U0U1[ijk]*dphi_D1[ijk]*
dpsi_D0[ijk] + _gammaI_U0U2[ijk]*dphi_D0[ijk]*dpsi_D2[ijk] +
_gammaI_U0U2[ijk]*dphi_D2[ijk]*dpsi_D0[ijk] + _gammaI_U1U1[ijk]*
dphi_D1[ijk]*dpsi_D1[ijk] + _gammaI_U1U2[ijk]*dphi_D1[ijk]*
dpsi_D2[ijk] + _gammaI_U1U2[ijk]*dphi_D2[ijk]*dpsi_D1[ijk] +
_gammaI_U2U2[ijk]*dphi_D2[ijk]*dpsi_D2[ijk])/pow(psi[ijk], 5);

  double t3 = 
-(_gammaI_U0U0[ijk]*(_Gamma_U0D0D0[ijk]*dphi_D0[ijk] +
_Gamma_U1D0D0[ijk]*dphi_D1[ijk] + _Gamma_U2D0D0[ijk]*dphi_D2[ijk] -
ddphi_D0D0[ijk]) + 2.0*_gammaI_U0U1[ijk]*(_Gamma_U0D0D1[ijk]*
dphi_D0[ijk] + _Gamma_U1D0D1[ijk]*dphi_D1[ijk] + _Gamma_U2D0D1[ijk]*
dphi_D2[ijk] - ddphi_D0D1[ijk]) + 2.0*_gammaI_U0U2[ijk]*
(_Gamma_U0D0D2[ijk]*dphi_D0[ijk] + _Gamma_U1D0D2[ijk]*dphi_D1[ijk] +
_Gamma_U2D0D2[ijk]*dphi_D2[ijk] - ddphi_D0D2[ijk]) + _gammaI_U1U1[ijk]*
(_Gamma_U0D1D1[ijk]*dphi_D0[ijk] + _Gamma_U1D1D1[ijk]*dphi_D1[ijk] +
_Gamma_U2D1D1[ijk]*dphi_D2[ijk] - ddphi_D1D1[ijk]) + 2.0*
_gammaI_U1U2[ijk]*(_Gamma_U0D1D2[ijk]*dphi_D0[ijk] +
_Gamma_U1D1D2[ijk]*dphi_D1[ijk] + _Gamma_U2D1D2[ijk]*dphi_D2[ijk] -
ddphi_D1D2[ijk]) + _gammaI_U2U2[ijk]*(_Gamma_U0D2D2[ijk]*dphi_D0[ijk] +
_Gamma_U1D2D2[ijk]*dphi_D1[ijk] + _Gamma_U2D2D2[ijk]*dphi_D2[ijk] -
ddphi_D2D2[ijk]))/pow(psi[ijk], 4);

  double t4 = 
(6.0*W_U0[ijk]*dpsi_D0[ijk] + 6.0*W_U1[ijk]*dpsi_D1[ijk] + 6.0*
W_U2[ijk]*dpsi_D2[ijk] + psi[ijk]*(W_U0[ijk]*_Gamma_U0D0D0[ijk] +
W_U0[ijk]*_Gamma_U1D0D1[ijk] + W_U0[ijk]*_Gamma_U2D0D2[ijk] +
W_U1[ijk]*_Gamma_U0D0D1[ijk] + W_U1[ijk]*_Gamma_U1D1D1[ijk] +
W_U1[ijk]*_Gamma_U2D1D2[ijk] + W_U2[ijk]*_Gamma_U0D0D2[ijk] +
W_U2[ijk]*_Gamma_U1D1D2[ijk] + W_U2[ijk]*_Gamma_U2D2D2[ijk]))/
psi[ijk];

  double t5 = 
-enthalpy[ijk]*u0[ijk]*(Beta_U0[ijk]*dLns1_U0 + Beta_U1[ijk]*dLns1_U1 +
Beta_U2[ijk]*dLns1_U2);

  double t6 = 
-K[ijk]*alpha*enthalpy[ijk]*rho0[ijk]*u0[ijk];

  double F_eq = 
att*t3*pow(rho0[ijk]/rhoc - 1, 4) + rho0[ijk]*(t2 + t3 + t4) + t1 +
t5 + t6;

  F[n] = F_eq;

  DDM_SCHUR_EQ_CLOSE

  if(strstr(patch->name,"left_central_box"))
  {
    const double NS_center[3] = {0,GetParameterD_E("NS_center"),0};
    Interpolation_T *interp_phi0 = init_interpolation();
    double interp;
    double X[3] = {0};

    X_of_x(X,NS_center,patch);
    interp_phi0->field = patch->pool[Ind("phi")];
    interp_phi0->X = X[0];
    interp_phi0->Y = X[1];
    interp_phi0->Z = X[2];
    interp_phi0->XYZ_dir_flag = 1;
    plan_interpolation(interp_phi0);
    interp = execute_interpolation(interp_phi0);
    free_interpolation(interp_phi0);

    for (n = 0; n < N; ++n)
    	F[n] += interp;
   
  }
  return 0;
}
