/*
  These C codes generated by Cpi version 1.0
  Copyright (C) 2019 Alireza Rashti.
*/


#include "bbn_headers.h"

double bbn_BH_Kommar_mass(Grid_T *const grid);
double bbn_BH_Kommar_mass(Grid_T *const grid)
{
  double BH_Kommar_mass = 0;
  unsigned p;

  FOR_ALL_PATCHES(p,grid)
  {
    Patch_T *patch = grid->patch[p];
    unsigned nn    = patch->nn;
    unsigned ijk;

    if (!IsItHorizonPatch(patch))
      continue;
    ADD_FIELD(BH_Kommar_mass_integrand)

    double *g00 = alloc_double(nn);
    double *g01 = alloc_double(nn);
    double *g02 = alloc_double(nn);
    double *g11 = alloc_double(nn);
    double *g12 = alloc_double(nn);
    double *g22 = alloc_double(nn);

    /* declaring: */
    GET_FIELD(_gamma_D2D2)
    GET_FIELD(_gamma_D0D2)
    GET_FIELD(_gamma_D0D0)
    GET_FIELD(_gamma_D0D1)
    GET_FIELD(_gamma_D1D2)
    GET_FIELD(_gamma_D1D1)
    GET_FIELD(_A_UiUj_U2U2)
    GET_FIELD(_A_UiUj_U1U2)
    GET_FIELD(_A_UiUj_U1U1)
    GET_FIELD(_A_UiUj_U0U2)
    GET_FIELD(_A_UiUj_U0U1)
    GET_FIELD(_A_UiUj_U0U0)
    GET_FIELD(eta)
    GET_FIELD(deta_D0)
    GET_FIELD(deta_D1)
    GET_FIELD(deta_D2)
    GET_FIELD(Beta_U1)
    GET_FIELD(Beta_U0)
    GET_FIELD(Beta_U2)
    GET_FIELD(K)
    GET_FIELD(psi)
    GET_FIELD(dpsi_D0)
    GET_FIELD(dpsi_D1)
    GET_FIELD(dpsi_D2)
    GET_FIELD(_HS_U2)
    GET_FIELD(_HS_U0)
    GET_FIELD(_HS_U1)


{
    PREP_FIELD(BH_Kommar_mass_integrand)
    for(ijk = 0; ijk < nn; ++ijk)
    {
    double psim2 = 
pow(psi[ijk], -2);

    double psi2 = 
pow(psi[ijk], 2);

    double psi4 = 
pow(psi[ijk], 4);

    double s_U1 = 
_HS_U1[ijk]*psim2;

    double s_U0 = 
_HS_U0[ijk]*psim2;

    double s_U2 = 
_HS_U2[ijk]*psim2;

    double dalpha_U1 = 
deta_D1[ijk]/psi[ijk] - dpsi_D1[ijk]*eta[ijk]/psi2;

    double dalpha_U0 = 
deta_D0[ijk]/psi[ijk] - dpsi_D0[ijk]*eta[ijk]/psi2;

    double dalpha_U2 = 
deta_D2[ijk]/psi[ijk] - dpsi_D2[ijk]*eta[ijk]/psi2;

    double K_DD_D1D1 = 
0.33333333333333331*K[ijk]*_gamma_D1D1[ijk]*psi4 + psim2*
(_A_UiUj_U0U0[ijk]*pow(_gamma_D0D1[ijk], 2) + 2.0*_A_UiUj_U0U1[ijk]*
_gamma_D0D1[ijk]*_gamma_D1D1[ijk] + 2.0*_A_UiUj_U0U2[ijk]*
_gamma_D0D1[ijk]*_gamma_D1D2[ijk] + _A_UiUj_U1U1[ijk]*
pow(_gamma_D1D1[ijk], 2) + 2.0*_A_UiUj_U1U2[ijk]*_gamma_D1D1[ijk]*
_gamma_D1D2[ijk] + _A_UiUj_U2U2[ijk]*pow(_gamma_D1D2[ijk], 2));

    double K_DD_D1D2 = 
0.33333333333333331*K[ijk]*_gamma_D1D2[ijk]*psi4 + psim2*
(_A_UiUj_U0U0[ijk]*_gamma_D0D1[ijk]*_gamma_D0D2[ijk] + 
_A_UiUj_U0U1[ijk]*_gamma_D0D1[ijk]*_gamma_D1D2[ijk] + 
_A_UiUj_U0U1[ijk]*_gamma_D0D2[ijk]*_gamma_D1D1[ijk] + 
_A_UiUj_U0U2[ijk]*_gamma_D0D1[ijk]*_gamma_D2D2[ijk] + 
_A_UiUj_U0U2[ijk]*_gamma_D0D2[ijk]*_gamma_D1D2[ijk] + 
_A_UiUj_U1U1[ijk]*_gamma_D1D1[ijk]*_gamma_D1D2[ijk] + 
_A_UiUj_U1U2[ijk]*_gamma_D1D1[ijk]*_gamma_D2D2[ijk] + 
_A_UiUj_U1U2[ijk]*pow(_gamma_D1D2[ijk], 2) + _A_UiUj_U2U2[ijk]*
_gamma_D1D2[ijk]*_gamma_D2D2[ijk]);

    double K_DD_D2D2 = 
0.33333333333333331*K[ijk]*_gamma_D2D2[ijk]*psi4 + psim2*
(_A_UiUj_U0U0[ijk]*pow(_gamma_D0D2[ijk], 2) + 2.0*_A_UiUj_U0U1[ijk]*
_gamma_D0D2[ijk]*_gamma_D1D2[ijk] + 2.0*_A_UiUj_U0U2[ijk]*
_gamma_D0D2[ijk]*_gamma_D2D2[ijk] + _A_UiUj_U1U1[ijk]*
pow(_gamma_D1D2[ijk], 2) + 2.0*_A_UiUj_U1U2[ijk]*_gamma_D1D2[ijk]*
_gamma_D2D2[ijk] + _A_UiUj_U2U2[ijk]*pow(_gamma_D2D2[ijk], 2));

    double K_DD_D0D0 = 
0.33333333333333331*K[ijk]*_gamma_D0D0[ijk]*psi4 + psim2*
(_A_UiUj_U0U0[ijk]*pow(_gamma_D0D0[ijk], 2) + 2.0*_A_UiUj_U0U1[ijk]*
_gamma_D0D0[ijk]*_gamma_D0D1[ijk] + 2.0*_A_UiUj_U0U2[ijk]*
_gamma_D0D0[ijk]*_gamma_D0D2[ijk] + _A_UiUj_U1U1[ijk]*
pow(_gamma_D0D1[ijk], 2) + 2.0*_A_UiUj_U1U2[ijk]*_gamma_D0D1[ijk]*
_gamma_D0D2[ijk] + _A_UiUj_U2U2[ijk]*pow(_gamma_D0D2[ijk], 2));

    double K_DD_D0D1 = 
0.33333333333333331*K[ijk]*_gamma_D0D1[ijk]*psi4 + psim2*
(_A_UiUj_U0U0[ijk]*_gamma_D0D0[ijk]*_gamma_D0D1[ijk] + 
_A_UiUj_U0U1[ijk]*_gamma_D0D0[ijk]*_gamma_D1D1[ijk] + 
_A_UiUj_U0U1[ijk]*pow(_gamma_D0D1[ijk], 2) + _A_UiUj_U0U2[ijk]*
_gamma_D0D0[ijk]*_gamma_D1D2[ijk] + _A_UiUj_U0U2[ijk]*_gamma_D0D1[ijk]*
_gamma_D0D2[ijk] + _A_UiUj_U1U1[ijk]*_gamma_D0D1[ijk]*
_gamma_D1D1[ijk] + _A_UiUj_U1U2[ijk]*_gamma_D0D1[ijk]*
_gamma_D1D2[ijk] + _A_UiUj_U1U2[ijk]*_gamma_D0D2[ijk]*
_gamma_D1D1[ijk] + _A_UiUj_U2U2[ijk]*_gamma_D0D2[ijk]*
_gamma_D1D2[ijk]);

    double K_DD_D0D2 = 
0.33333333333333331*K[ijk]*_gamma_D0D2[ijk]*psi4 + psim2*
(_A_UiUj_U0U0[ijk]*_gamma_D0D0[ijk]*_gamma_D0D2[ijk] + 
_A_UiUj_U0U1[ijk]*_gamma_D0D0[ijk]*_gamma_D1D2[ijk] + 
_A_UiUj_U0U1[ijk]*_gamma_D0D1[ijk]*_gamma_D0D2[ijk] + 
_A_UiUj_U0U2[ijk]*_gamma_D0D0[ijk]*_gamma_D2D2[ijk] + 
_A_UiUj_U0U2[ijk]*pow(_gamma_D0D2[ijk], 2) + _A_UiUj_U1U1[ijk]*
_gamma_D0D1[ijk]*_gamma_D1D2[ijk] + _A_UiUj_U1U2[ijk]*_gamma_D0D1[ijk]*
_gamma_D2D2[ijk] + _A_UiUj_U1U2[ijk]*_gamma_D0D2[ijk]*
_gamma_D1D2[ijk] + _A_UiUj_U2U2[ijk]*_gamma_D0D2[ijk]*
_gamma_D2D2[ijk]);

    double integrand = 
-s_U0*(Beta_U0[ijk]*K_DD_D0D0 + Beta_U1[ijk]*K_DD_D0D1 + Beta_U2[ijk]*
K_DD_D0D2 - dalpha_U0) - s_U1*(Beta_U0[ijk]*K_DD_D0D1 + Beta_U1[ijk]*
K_DD_D1D1 + Beta_U2[ijk]*K_DD_D1D2 - dalpha_U1) - s_U2*(Beta_U0[ijk]*
K_DD_D0D2 + Beta_U1[ijk]*K_DD_D1D2 + Beta_U2[ijk]*K_DD_D2D2 -
dalpha_U2);


      BH_Kommar_mass_integrand[ijk] = integrand;
      /* metric */
      g00[ijk] = psi4*_gamma_D0D0[ijk];
      g01[ijk] = psi4*_gamma_D0D1[ijk];
      g02[ijk] = psi4*_gamma_D0D2[ijk];
      g11[ijk] = psi4*_gamma_D1D1[ijk];
      g12[ijk] = psi4*_gamma_D1D2[ijk];
      g22[ijk] = psi4*_gamma_D2D2[ijk];
    }
}

  DECLARE_FIELD(BH_Kommar_mass_integrand)
  Integration_T *I = init_integration();
  I->type = "Integral{f(x)dS},Spectral";
  I->Spectral->f = BH_Kommar_mass_integrand;
  I->g00 = g00;
  I->g01 = g01;
  I->g02 = g02;
  I->g11 = g11;
  I->g12 = g12;
  I->g22 = g22;
  I->Spectral->Z_surface = 1;
  I->Spectral->K         = 0;
  plan_integration(I);
  BH_Kommar_mass += execute_integration(I);

  free_integration(I);
  REMOVE_FIELD(BH_Kommar_mass_integrand)
  free(g00);
  free(g01);
  free(g02);
  free(g11);
  free(g12);
  free(g22);
  }

  BH_Kommar_mass /= (4*M_PI);
  return BH_Kommar_mass;
}
